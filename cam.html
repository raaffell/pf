<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cermin Instant - Versi Perbaikan</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#ff46a3;
  --bg1:#fcb6e2;
  --bg2:#8ec0f9;
  --glass:rgba(255,255,255,0.25);
  --glass-border:1px solid rgba(255,255,255,0.15);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  display:flex;
  justify-content:center;
  padding:20px;
  font-family:'Poppins',sans-serif;
  color:#fff;
}
.app{
  width:100%;
  max-width:1100px;
  display:grid;
  grid-template-columns:1fr 380px;
  gap:25px;
}
@media(max-width:900px){.app{grid-template-columns:1fr;}}

/* Card Styles */
.mirror-card{
  background:var(--glass);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  padding:24px;
  border-radius:24px;
  box-shadow:0 12px 40px rgba(0,0,0,0.2);
  border:var(--glass-border);
  display:flex; flex-direction:column;
}

.mirror-head{
  margin-bottom:20px;
  text-align:center;
}
.title{
  font-family:'Pacifico',cursive;
  font-size:36px;
  background:linear-gradient(90deg,#ff46a3,#fff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:5px;
}
.sub{
  font-size:15px;
  opacity:0.9;
  font-weight:400;
}

/* Video Area */
.video-wrap{
  position:relative;
  border-radius:20px;
  overflow:hidden;
  border:4px solid rgba(255,255,255,0.2);
  background:#000;
  aspect-ratio:4/3;
  box-shadow:inset 0 0 20px rgba(0,0,0,0.5);
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transform:scaleX(-1); /* Default mirror */
}
.shutter{
  position:absolute; inset:0;
  background:#fff;
  opacity:0;
  pointer-events:none;
}
.shutter.flash{animation:flash .3s ease-out forwards}
@keyframes flash{0%{opacity:0}10%{opacity:1}100%{opacity:0}}

/* Capture Button */
.capture-btn{
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%); /* Posisi tengah */
  width:64px;
  height:64px;
  border-radius:50%;
  background:#fff;
  border:4px solid rgba(0,0,0,0.1);
  color:var(--accent);
  font-size:28px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 4px 15px rgba(0,0,0,0.3);
  transition:transform 0.1s;
}
/* Hanya efek mengecil saat ditekan, tanpa goyang saat hover */
.capture-btn:active{transform:translateX(-50%) scale(0.9);}

/* Controls Area */
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:20px;
  flex-wrap:wrap;
  justify-content:center;
}
select, button{
  appearance:none;
  border:0;
  padding:10px 16px;
  border-radius:14px;
  background:rgba(255,255,255,0.9);
  color:#444;
  font-family:'Poppins',sans-serif;
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

/* PERBAIKAN: Tombol umum naik saat hover, KECUALI tombol capture agar tidak goyang */
select:hover, button:not(.capture-btn):hover{background:#fff; transform:translateY(-2px);}

.ghost{background:rgba(0,0,0,0.2); color:#fff; border:1px solid rgba(255,255,255,0.2);}
.ghost:hover{background:rgba(0,0,0,0.4);}

/* Countdown */
#countdown{
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:80px;
  font-weight:700;
  color:#fff;
  text-shadow:0 4px 10px rgba(0,0,0,0.5);
  pointer-events:none;
  display:none;
}

/* Sidebar Gallery */
.side-card{
  background:rgba(255,255,255,0.15);
  backdrop-filter:blur(10px);
  padding:20px;
  border-radius:20px;
  border:var(--glass-border);
  display:flex; flex-direction:column;
  height: fit-content;
}
.side-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
  padding-bottom:10px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.gallery{
  display:flex;
  flex-direction:column;
  gap:12px;
  max-height:60vh;
  overflow-y:auto;
  padding:4px;
}
/* Custom Scrollbar */
.gallery::-webkit-scrollbar{width:6px;}
.gallery::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.3);border-radius:10px;}

.thumb-row{
  display:flex;
  gap:10px;
  background:rgba(0,0,0,0.2);
  padding:8px;
  border-radius:12px;
  align-items:center;
  transition:background 0.2s;
}
.thumb-row:hover{background:rgba(0,0,0,0.3);}
.thumb-img{
  width:80px;
  height:60px;
  border-radius:8px;
  object-fit:cover;
  cursor:pointer;
  border:2px solid transparent;
}
.thumb-img:hover{border-color:var(--accent);}
.thumb-info{
  flex:1;
  font-size:13px;
  font-weight:600;
  color:#fff;
}
.btn-icon{
  padding:6px;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  font-size:14px;
  margin-left:5px;
}
.del-btn{background:rgba(255,70,163,0.2); color:#ff8cc8;}
.del-btn:hover{background:#ff46a3; color:#fff;}

.empty{opacity:0.6;padding:20px;text-align:center;font-style:italic;font-size:14px;}

/* Modal */
.modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.8);z-index:100;backdrop-filter:blur(5px);}
.modal.show{display:flex;animation:fadeIn 0.2s ease-out;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-card{max-width:90%;width:auto;background:#111;padding:10px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.5);border:1px solid #333;}
.modal-card img{max-height:80vh;max-width:100%;border-radius:12px;display:block;}
.modal-actions{display:flex;gap:10px;justify-content:center;margin-top:15px;}
</style>
</head>
<body>

<div class="app">
  <!-- Kamera Section -->
  <div class="mirror-card">
    <div class="mirror-head">
      <div class="title">Cermin Instant</div>
      <div class="sub"></div>
    </div>

    <div class="video-wrap" id="videoWrap">
      <video id="video" autoplay muted playsinline></video>
      <div class="shutter" id="shutter"></div>
      <div id="countdown"></div>
      <button class="capture-btn" id="captureBtn">üì∏</button>
    </div>

    <div class="controls">
      <select id="timerSelect">
        <option value="0">üöÄ Langsung</option>
        <option value="3" selected>‚è± 3 detik</option>
        <option value="5">‚è± 5 detik</option>
        <option value="10">‚è± 10 detik</option>
      </select>

      <select id="filterSelect"></select>

      <button id="switchCamBtn">üîÑ Kamera</button>
      
      <select id="mirrorSelect">
        <option value="mirror">ü™û Mirror</option>
        <option value="no-mirror">‚û°Ô∏è Normal</option>
      </select>
      
      <button id="clearBtn" class="ghost">üóë Bersihkan</button>
      <button id="downloadAllBtn" class="ghost">‚¨áÔ∏è Simpan Semua</button>
    </div>
  </div>

  <!-- Gallery Section -->
  <div class="side-card">
    <div class="side-head">
      <div><strong>Galeri Foto</strong></div>
      <small id="galleryCount" style="opacity:0.8">0 / 5</small>
    </div>
    <div class="gallery" id="gallery">
      <div class="empty">Belum ada foto.</div>
    </div>
  </div>
</div>

<!-- Modal Preview -->
<div class="modal" id="modal">
  <div class="modal-card">
    <img id="modalImg" src="" alt="Preview">
    <div class="modal-actions">
      <button id="modalDownload">‚¨áÔ∏è Simpan</button>
      <button id="modalDelete" class="ghost" style="color:#ff6b6b; border-color:#ff6b6b;">‚úñ Hapus</button>
      <button id="modalClose" class="ghost">Tutup</button>
    </div>
  </div>
</div>

<script>
// --- KONFIGURASI & VARIABEL ---
let video = document.getElementById('video');
let countdownEl = document.getElementById('countdown');
let shutter = document.getElementById('shutter');
let captureBtn = document.getElementById('captureBtn');
let timerSelect = document.getElementById('timerSelect');
let filterSelect = document.getElementById('filterSelect');
let mirrorSelect = document.getElementById('mirrorSelect');
let gallery = document.getElementById('gallery');
let clearBtn = document.getElementById('clearBtn');
let downloadAllBtn = document.getElementById('downloadAllBtn');
let galleryCount = document.getElementById('galleryCount');
let modal = document.getElementById('modal');
let modalImg = document.getElementById('modalImg');
let modalDownload = document.getElementById('modalDownload');
let modalDelete = document.getElementById('modalDelete');
let modalClose = document.getElementById('modalClose');
let switchCamBtn = document.getElementById('switchCamBtn');

let galleryList = []; // Menyimpan data string base64 gambar
let currentModalIndex = -1;
let currentStream = null;
let useFrontCamera = true;
let mirrorMode = true;
const MAX_PHOTOS = 5;

// --- DAFTAR FILTER ---
const filters = [
  {name: "‚ú® Normal", value: "none"},
  {name: "‚ö´ Hitam Putih", value: "grayscale(100%)"},
  {name: "ü•Ä Sepia", value: "sepia(100%)"},
  {name: "üåô Negatif", value: "invert(100%)"},
  {name: "üíñ Beauty Soft", value: "contrast(110%) brightness(110%) saturate(110%)"},
  {name: "üåà Warna Cerah", value: "saturate(160%)"},
  {name: "üå∏ Pink Soft", value: "contrast(110%) brightness(105%) saturate(120%) hue-rotate(-10deg)"},
  {name: "‚ú® Film Grain", value: "grain"}, // Custom logic
  {name: "üåÖ Vintage", value: "contrast(120%) sepia(30%) saturate(130%)"},
  {name: "üé¨ Sinema", value: "contrast(130%) saturate(80%) brightness(90%)"},
  {name: "‚ùÑÔ∏è Dingin", value: "hue-rotate(180deg) contrast(120%)"}
];

// Populate filter select
filters.forEach(f => {
  const opt = document.createElement('option');
  opt.textContent = f.name;
  opt.value = f.value;
  filterSelect.appendChild(opt);
});

// --- FUNGSI KAMERA ---
async function startCamera(){
  if(currentStream) currentStream.getTracks().forEach(track => track.stop());
  try{
    const constraints = {
      video: {
        facingMode: useFrontCamera ? 'user' : 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    video.srcObject = stream;
    applyMirror();
    await video.play();
  } catch(err){
    console.error(err);
    alert("Gagal mengakses kamera. Pastikan izin kamera diberikan.");
  }
}

function applyMirror(){
  if(mirrorMode){
    video.style.transform = "scaleX(-1)";
  } else {
    video.style.transform = "scaleX(1)";
  }
}

switchCamBtn.addEventListener('click', () => {
  useFrontCamera = !useFrontCamera;
  startCamera();
});

mirrorSelect.addEventListener('change', () => {
  mirrorMode = mirrorSelect.value === 'mirror';
  applyMirror();
});

// Terapkan filter live ke video
filterSelect.addEventListener('change', () => {
  applyFilterToVideo();
});

function applyFilterToVideo(){
  const val = filterSelect.value;
  if(val === 'grain'){
    video.style.filter = "contrast(110%) brightness(105%)"; // Basic preview for grain
  } else {
    video.style.filter = val;
  }
}

// --- PROSES FOTO (TANGKAP LAYAR) ---
captureBtn.addEventListener('click', () => {
  let t = parseInt(timerSelect.value, 10);
  
  if(t === 0){
    doCapture();
    return;
  }

  // Timer Logic
  captureBtn.disabled = true;
  captureBtn.style.opacity = "0.5";
  countdownEl.style.display = "block";
  countdownEl.textContent = t;
  
  let timerInterval = setInterval(() => {
    t--;
    if(t > 0){
      countdownEl.textContent = t;
    } else {
      clearInterval(timerInterval);
      countdownEl.style.display = "none";
      doCapture();
      captureBtn.disabled = false;
      captureBtn.style.opacity = "1";
    }
  }, 1000);
});

function doCapture(){
  // Efek Flash
  shutter.classList.remove('flash');
  void shutter.offsetWidth; // Trigger reflow
  shutter.classList.add('flash');

  // Siapkan Canvas
  const w = video.videoWidth || 640;
  const h = video.videoHeight || 480;
  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');

  // 1. Handle Mirror di Canvas
  if(mirrorMode){
    ctx.translate(w, 0);
    ctx.scale(-1, 1);
  }

  // 2. Handle Filter
  const selectedFilter = filterSelect.value;
  
  // Jika filter Grain/Bintik, kita gambar manual
  if(selectedFilter === 'grain'){
    ctx.filter = "contrast(110%) brightness(105%) saturate(100%)";
    ctx.drawImage(video, 0, 0, w, h);
    
    // Tambahkan noise di atas gambar
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;
    for(let i=0; i < data.length; i+=4){
      const noise = (Math.random() - 0.5) * 40;
      data[i] = Math.min(255, Math.max(0, data[i] + noise));     // R
      data[i+1] = Math.min(255, Math.max(0, data[i+1] + noise)); // G
      data[i+2] = Math.min(255, Math.max(0, data[i+2] + noise)); // B
    }
    ctx.putImageData(imgData, 0, 0);
  } else {
    ctx.filter = selectedFilter;
    ctx.drawImage(video, 0, 0, w, h);
  }

  // Simpan ke galeri
  const dataUrl = canvas.toDataURL('image/png');
  addToGallery(dataUrl);
}

// --- MANAJEMEN GALERI (DIPERBAIKI) ---

// Fungsi utama: Render ulang seluruh galeri berdasarkan data array
// Ini mencegah bug "indeks salah" saat menghapus foto di tengah.
function renderGallery(){
  gallery.innerHTML = ''; // Bersihkan tampilan
  
  // Update Counter
  galleryCount.textContent = `${galleryList.length} / ${MAX_PHOTOS}`;

  if(galleryList.length === 0){
    gallery.innerHTML = '<div class="empty">Belum ada foto. Ambil foto untuk mengisi galeri.</div>';
    return;
  }

  // Loop data dan buat elemen DOM baru
  galleryList.forEach((dataUrl, index) => {
    const row = document.createElement('div');
    row.className = 'thumb-row';

    const img = document.createElement('img');
    img.src = dataUrl;
    img.className = 'thumb-img';
    img.onclick = () => openModal(index);

    const info = document.createElement('div');
    info.className = 'thumb-info';
    info.textContent = `Foto ${index + 1}`;

    // Tombol Hapus Kecil di List
    const btnDel = document.createElement('button');
    btnDel.className = 'btn-icon del-btn';
    btnDel.innerHTML = '‚úñ';
    btnDel.title = "Hapus foto ini";
    btnDel.onclick = (e) => {
      e.stopPropagation(); // Jangan buka modal saat klik hapus
      deletePhoto(index);
    };

    row.appendChild(img);
    row.appendChild(info);
    row.appendChild(btnDel);
    gallery.appendChild(row);
  });
}

function addToGallery(data){
  // Jika penuh, hapus yang paling lama (indeks 0)
  if(galleryList.length >= MAX_PHOTOS){
    galleryList.shift();
  }
  
  galleryList.push(data);
  renderGallery(); // Render ulang agar UI sinkron dengan data
}

// Fungsi Hapus yang Robust
function deletePhoto(index){
  if(index < 0 || index >= galleryList.length) return;
  
  // Hapus dari array
  galleryList.splice(index, 1);
  
  // Render ulang tampilan
  renderGallery();
  
  // Jika modal sedang terbuka untuk foto ini, tutup
  if(modal.classList.contains('show')){
    modal.classList.remove('show');
  }
}

// Tombol Bersihkan Semua
clearBtn.addEventListener('click', () => {
  if(galleryList.length === 0) return;
  if(confirm('Yakin ingin menghapus semua foto di galeri?')){
    galleryList = [];
    renderGallery();
  }
});

// Download Semua
downloadAllBtn.addEventListener('click', () => {
  if(galleryList.length === 0) return alert('Galeri kosong!');
  
  // Beri sedikit jeda antar download agar browser tidak memblokir
  galleryList.forEach((url, i) => {
    setTimeout(() => {
      const link = document.createElement('a');
      link.href = url;
      link.download = `cermin_instant_${i+1}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }, i * 300); // Jeda 300ms per file
  });
});

// --- MODAL PREVIEW ---
function openModal(index){
  if(index < 0 || index >= galleryList.length) return;
  currentModalIndex = index;
  modalImg.src = galleryList[index];
  modal.classList.add('show');
}

modalClose.addEventListener('click', () => modal.classList.remove('show'));
modal.addEventListener('click', (e) => {
  if(e.target === modal) modal.classList.remove('show');
});

modalDownload.addEventListener('click', () => {
  if(currentModalIndex === -1) return;
  const link = document.createElement('a');
  link.href = galleryList[currentModalIndex];
  link.download = `cermin_instant_${currentModalIndex+1}.png`;
  link.click();
});

modalDelete.addEventListener('click', () => {
  if(currentModalIndex === -1) return;
  // Gunakan fungsi hapus global
  deletePhoto(currentModalIndex);
});

// --- INIT ---
// Mulai kamera saat halaman dimuat
startCamera();
applyFilterToVideo(); // Set filter awal
</script>

</body>
</html>
